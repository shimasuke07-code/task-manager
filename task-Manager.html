import React, { useState, useEffect, useMemo, useRef } from 'react';
import { initializeApp } from 'firebase/app';
import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from 'firebase/auth';
import { getFirestore, doc, setDoc, getDoc, collection, onSnapshot, query, serverTimestamp, updateDoc } from 'firebase/firestore';
import { 
  Plus, Trash2, CheckCircle2, Circle, Calendar as CalendarIcon, 
  List, ChevronLeft, ChevronRight, Play, Pause, Maximize2, 
  Zap, Star, Trophy, Sword, Sparkles, Award, Shrink, Flame,
  User, Users, Settings, Save, Globe, Shield, Heart, Ghost, 
  Crown, Smile, Coffee, Wind, Target, Rocket, Volume2, Palette,
  Sun, Moon, Trees, Mountain, Skull, Gem, Zap as Flash, Waves,
  Medal, Music, CloudRain, VolumeX, BarChart3, Backpack, Wand2,
  Brain, Zap as Bolt, UserPlus, Eye, Activity, ShoppingBag, Coins, X,
  Calendar, Clock, ScrollText, Flag, Timer, BookOpen, PenTool, Tv,
  CheckSquare
} from 'lucide-react';

// --- Firebase Configuration ---
const firebaseConfig = JSON.parse(__firebase_config);
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const appId = typeof __app_id !== 'undefined' ? __app_id : 'focus-rpg-app';
const apiKey = ""; 

// --- Audio Utility ---
const playVoice = async (text) => {
  try {
    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        contents: [{ parts: [{ text }] }],
        generationConfig: {
          responseModalities: ["AUDIO"],
          speechConfig: {
            voiceConfig: {
              prebuiltVoiceConfig: { voiceName: "Kore" }
            }
          }
        }
      })
    });

    const result = await response.json();
    const base64Audio = result.candidates?.[0]?.content?.parts?.[0]?.inlineData?.data;
    
    if (base64Audio) {
      const audioData = atob(base64Audio);
      const arrayBuffer = new ArrayBuffer(audioData.length);
      const view = new Uint8Array(arrayBuffer);
      for (let i = 0; i < audioData.length; i++) {
        view[i] = audioData.charCodeAt(i);
      }
      
      const wavHeader = new ArrayBuffer(44);
      const d = new DataView(wavHeader);
      const sampleRate = 24000;
      d.setUint32(0, 0x52494646, false); d.setUint32(4, 36 + arrayBuffer.byteLength, true);
      d.setUint32(8, 0x57415645, false); d.setUint32(12, 0x666d7420, false);
      d.setUint16(20, 1, true); d.setUint16(22, 1, true);
      d.setUint32(24, sampleRate, true); d.setUint32(28, sampleRate * 2, true);
      d.setUint16(32, 2, true); d.setUint16(34, 16, true);
      d.setUint32(36, 0x64617461, false); d.setUint32(40, arrayBuffer.byteLength, true);

      const blob = new Blob([wavHeader, arrayBuffer], { type: 'audio/wav' });
      const url = URL.createObjectURL(blob);
      const audio = new Audio(url);
      audio.play();
    }
  } catch (error) {
    console.error("Audio playback failed", error);
  }
};

// --- Confetti Effect Component ---
const Confetti = () => {
  return (
    <div className="fixed inset-0 pointer-events-none z-[600] overflow-hidden">
      {[...Array(60)].map((_, i) => (
        <div 
          key={i}
          className="absolute w-2 h-2 rounded-sm animate-ping"
          style={{
            left: `${Math.random() * 100}%`,
            top: `-10%`,
            backgroundColor: ['#6366f1', '#fbbf24', '#f472b6', '#4ade80', '#22d3ee', '#ef4444'][Math.floor(Math.random() * 6)],
            animation: `confetti-fall ${1.5 + Math.random() * 2}s linear forwards`,
            transform: `rotate(${Math.random() * 360}deg)`
          }}
        />
      ))}
      <style>{`
        @keyframes confetti-fall {
          0% { transform: translateY(0) rotate(0deg); opacity: 1; }
          100% { transform: translateY(110vh) rotate(720deg); opacity: 0; }
        }
      `}</style>
    </div>
  );
};

// --- Constant Data ---
const themes = {
  indigo: { name: '聖なる騎士', bg: 'bg-slate-50', primary: 'bg-indigo-600', primaryText: 'text-indigo-600', card: 'bg-white', border: 'border-indigo-100' },
  dark: { name: '深淵の魔王', bg: 'bg-slate-950', primary: 'bg-violet-600', primaryText: 'text-violet-400', card: 'bg-slate-900', border: 'border-slate-800' },
  gold: { name: '黄金の都', bg: 'bg-amber-50', primary: 'bg-amber-500', primaryText: 'text-amber-600', card: 'bg-white', border: 'border-amber-200' }
};

const jobClasses = [
  { id: 'warrior', name: '戦士', icon: <Sword />, description: '高い攻撃力と耐久力を誇る近接職。', stats: { str: 5, int: 1, agi: 2, luk: 2, mnd: 2, cha: 1 } },
  { id: 'mage', name: '魔術師', icon: <Wand2 />, description: '高い知力を持ち、魔法で敵を圧倒する。', stats: { str: 1, int: 5, agi: 1, luk: 2, mnd: 4, cha: 1 } },
  { id: 'thief', name: '狩人', icon: <Target />, description: '素早さと運に優れ、先手を打つのが得意。', stats: { str: 2, int: 2, agi: 5, luk: 3, mnd: 1, cha: 1 } },
  { id: 'cleric', name: '聖職者', icon: <Sparkles />, description: '精神力が高く、仲間を守る力を持つ。', stats: { str: 1, int: 3, agi: 1, luk: 2, mnd: 5, cha: 3 } }
];

const avatarIcons = {
  Sword: <Sword />, Heart: <Heart />, Shield: <Shield />, Ghost: <Ghost />, Crown: <Crown />, Smile: <Smile />, Rocket: <Rocket />, Coffee: <Coffee />, Flame: <Flame />, Star: <Star />, Zap: <Zap />, Gem: <Gem />
};

const shopItems = [
  { id: 'item_1', name: '真実の剣', type: 'weapon', price: 500, icon: <Sword />, effect: 'STR +10', stats: { str: 10 } },
  { id: 'item_2', name: '英知の法衣', type: 'armor', price: 800, icon: <Shield />, effect: 'INT +15', stats: { int: 15 } },
  { id: 'item_3', name: '黄金の冠', type: 'accessory', price: 1500, icon: <Crown />, effect: 'CHA +20', stats: { cha: 20 } },
  { id: 'avatar_flame', name: '炎のアバター', type: 'avatar', price: 300, icon: <Flame />, effect: 'アバター解禁: Flame' }
];

export default function App() {
  const [user, setUser] = useState(null);
  const [profile, setProfile] = useState({
    name: '名無しの冒険者', 
    title: '駆け出しの勇者',
    bio: '世界を救うために旅をしています。',
    avatar: 'Sword', 
    theme: 'indigo',
    job: 'warrior',
    gold: 100,
    statPoints: 0,
    stats: { str: 10, int: 10, agi: 10, luk: 10, mnd: 10, cha: 10 },
    equipment: { weapon: '錆びた剣', armor: '旅人の服', accessory: '初心者の腕輪' },
    unlockedAvatars: ['Sword', 'Heart', 'Shield', 'Ghost', 'Crown', 'Smile', 'Rocket', 'Coffee'],
    adCredits: 5, 
    lastAdDate: '' 
  });
  
  const [tasks, setTasks] = useState([]);
  const [dailyMissions, setDailyMissions] = useState([
    { id: 'daily_tasks', text: 'クエストを3回完了させる', xp: 100, gold: 50, completed: false, current: 0, target: 3 },
    { id: 'daily_level', text: 'レベルを1つ上げる', xp: 150, gold: 100, completed: false },
    { id: 'daily_focus', text: '集中を最後まで継続させる', xp: 80, gold: 40, completed: false }
  ]);
  const [inputValue, setInputValue] = useState('');
  const [inputDate, setInputDate] = useState('');
  const [viewMode, setViewMode] = useState('list'); 
  const [isFocusMode, setIsFocusMode] = useState(false);
  const [xp, setXp] = useState(0);
  const [level, setLevel] = useState(1);
  const [timeLeft, setTimeLeft] = useState(25 * 60);
  const [isActive, setIsActive] = useState(false);
  const [timerMode, setTimerMode] = useState('work');
  const [leaderboard, setLeaderboard] = useState([]);
  const [selectedUser, setSelectedUser] = useState(null);
  const [notification, setNotification] = useState(null);
  const [showConfetti, setShowConfetti] = useState(false);
  const [isAdPlaying, setIsAdPlaying] = useState(false);

  // Calendar State
  const [currentDate, setCurrentDate] = useState(new Date());

  // --- Auth & Data ---
  useEffect(() => {
    const initAuth = async () => {
      if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
        await signInWithCustomToken(auth, __initial_auth_token);
      } else {
        await signInAnonymously(auth);
      }
    };
    initAuth();
    onAuthStateChanged(auth, setUser);
  }, []);

  useEffect(() => {
    if (!user) return;
    const profileRef = doc(db, 'artifacts', appId, 'users', user.uid, 'settings', 'profile');
    getDoc(profileRef).then(docSnap => {
      if (docSnap.exists()) {
        const data = docSnap.data();
        const today = new Date().toLocaleDateString();
        let updatedProfile = { ...profile, ...data };
        if (data.lastAdDate !== today) {
          updatedProfile.adCredits = 5;
          updatedProfile.lastAdDate = today;
        }
        setProfile(updatedProfile);
        if (data.level) setLevel(data.level);
        if (data.xp) setXp(data.xp);
      }
    });

    const lbQuery = query(collection(db, 'artifacts', appId, 'public', 'data', 'leaderboard'));
    return onSnapshot(lbQuery, (snapshot) => {
      const data = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
      setLeaderboard(data.sort((a, b) => b.level - a.level || b.xp - a.xp).slice(0, 10));
    });
  }, [user]);

  // --- Daily Mission Logic ---
  useEffect(() => {
    const todayStr = new Date().toLocaleDateString();
    const lastDailyDate = localStorage.getItem('lastDailyDate');
    
    if (lastDailyDate !== todayStr) {
      const resetMissions = [
        { id: 'daily_tasks', text: 'クエストを3回完了させる', xp: 100, gold: 50, completed: false, current: 0, target: 3 },
        { id: 'daily_level', text: 'レベルを1つ上げる', xp: 150, gold: 100, completed: false },
        { id: 'daily_focus', text: '集中を最後まで継続させる', xp: 80, gold: 40, completed: false }
      ];
      setDailyMissions(resetMissions);
      localStorage.setItem('dailyMissions', JSON.stringify(resetMissions));
      localStorage.setItem('lastDailyDate', todayStr);
    } else {
      const saved = localStorage.getItem('dailyMissions');
      if (saved) setDailyMissions(JSON.parse(saved));
    }
  }, []);

  // --- Timer logic ---
  useEffect(() => {
    let interval = null;
    if (isActive && timeLeft > 0) {
      interval = setInterval(() => setTimeLeft((prev) => prev - 1), 1000);
    } else if (timeLeft === 0) {
      setIsActive(false);
      handleTimerComplete();
    }
    return () => clearInterval(interval);
  }, [isActive, timeLeft]);

  const handleTimerComplete = () => {
    if (timerMode === 'work') {
      gainRewards(50, 30);
      checkDailyMission('daily_focus');
      setTimerMode('break');
      setTimeLeft(5 * 60);
      notify("集中完了！ 50XP と 30G を獲得！");
      playVoice("Say excitedly: お疲れ様！集中クエストクリアだよ！");
      triggerConfetti();
    } else {
      setTimerMode('work');
      setTimeLeft(25 * 60);
      notify("休憩終了。次の冒険へ！");
    }
  };

  const gainRewards = (xpAmt, goldAmt) => {
    setXp(prev => {
      const newXp = prev + xpAmt;
      const xpToNext = level * 200;
      if (newXp >= xpToNext) {
        setLevel(l => {
          const newL = l + 1;
          checkDailyMission('daily_level');
          setProfile(p => {
              const updatedP = { ...p, statPoints: p.statPoints + 5 };
              updateGlobalProfile(newL, 0, p.gold + goldAmt, updatedP.statPoints, updatedP.adCredits, updatedP.lastAdDate);
              return updatedP;
          });
          return newL;
        });
        return 0;
      }
      setProfile(p => {
          const updatedP = { ...p, gold: p.gold + goldAmt };
          updateGlobalProfile(level, newXp, updatedP.gold, updatedP.statPoints, updatedP.adCredits, updatedP.lastAdDate);
          return updatedP;
      });
      return newXp;
    });
  };

  const checkDailyMission = (missionId) => {
    setDailyMissions(prev => {
      const updated = prev.map(m => {
        if (m.id === missionId && !m.completed) {
          if (missionId === 'daily_tasks') {
            const nextCount = (m.current || 0) + 1;
            if (nextCount >= (m.target || 3)) {
              triggerConfetti();
              notify(`デイリー任務達成！ ${m.xp}XP & ${m.gold}G！`);
              gainRewards(m.xp, m.gold);
              return { ...m, completed: true, current: nextCount };
            }
            return { ...m, current: nextCount };
          } else {
            triggerConfetti();
            notify(`デイリー任務達成！ ${m.xp}XP & ${m.gold}G！`);
            gainRewards(m.xp, m.gold);
            return { ...m, completed: true };
          }
        }
        return m;
      });
      localStorage.setItem('dailyMissions', JSON.stringify(updated));
      return updated;
    });
  };

  const updateGlobalProfile = async (newLvl = level, newXp = xp, newGold = profile.gold, newPoints = profile.statPoints, newAdCredits = profile.adCredits, newLastAdDate = profile.lastAdDate) => {
    if (!user) return;
    const lbRef = doc(db, 'artifacts', appId, 'public', 'data', 'leaderboard', user.uid);
    const pRef = doc(db, 'artifacts', appId, 'users', user.uid, 'settings', 'profile');
    const data = { 
        ...profile, 
        level: newLvl, 
        xp: newXp, 
        gold: newGold, 
        statPoints: newPoints, 
        adCredits: newAdCredits,
        lastAdDate: newLastAdDate,
        updatedAt: serverTimestamp() 
    };
    await setDoc(lbRef, data, { merge: true });
    await setDoc(pRef, data, { merge: true });
  };

  const notify = (msg) => {
    setNotification(msg);
    setTimeout(() => setNotification(null), 3000);
  };

  const triggerConfetti = () => {
    setShowConfetti(true);
    setTimeout(() => setShowConfetti(false), 3000);
  };

  const completeTask = (id) => {
    const task = tasks.find(t => t.id === id);
    if (!task || task.completed) return;

    triggerConfetti();
    gainRewards(20, 10);
    checkDailyMission('daily_tasks');
    notify("クエスト達成！報酬を獲得しました！");
    
    setTasks(prev => prev.map(t => t.id === id ? { ...t, completed: true } : t));

    setTimeout(() => {
      setTasks(prev => prev.filter(t => t.id !== id));
    }, 3000);
  };

  const buyItem = (item) => {
    if (profile.gold < item.price) {
      notify("ゴールドが足りません！");
      return;
    }
    let newProfile = { ...profile, gold: profile.gold - item.price };
    if (item.type === 'avatar') {
      const key = item.id.split('_')[1].charAt(0).toUpperCase() + item.id.split('_')[1].slice(1);
      if (!newProfile.unlockedAvatars.includes(key)) newProfile.unlockedAvatars.push(key);
    } else {
      newProfile.equipment[item.type] = item.name;
      if (item.stats) Object.keys(item.stats).forEach(s => newProfile.stats[s] += item.stats[s]);
    }
    setProfile(newProfile);
    updateGlobalProfile(level, xp, newProfile.gold, newProfile.statPoints, newProfile.adCredits, newProfile.lastAdDate);
    notify(`${item.name}を購入しました！`);
  };

  const addTask = (e) => {
    e.preventDefault();
    if(!inputValue) return;
    const newTask = {
      id: Date.now(),
      text: inputValue,
      deadline: inputDate,
      completed: false
    };
    setTasks([newTask, ...tasks]);
    setInputValue('');
    setInputDate('');
    notify("新しいクエストを受注しました！");
  };

  const allocatePoint = (stat) => {
    if (profile.statPoints <= 0) return;
    setProfile(prev => {
        const updated = {
            ...prev,
            statPoints: prev.statPoints - 1,
            stats: { ...prev.stats, [stat]: prev.stats[stat] + 1 }
        };
        updateGlobalProfile(level, xp, updated.gold, updated.statPoints, updated.adCredits, updated.lastAdDate);
        return updated;
    });
    notify(`${stat.toUpperCase()} が 1 上がった！`);
  };

  const handleWatchAd = () => {
    if (profile.adCredits <= 0) {
      notify("本日のボーナス獲得回数は終了しました");
      return;
    }
    setIsAdPlaying(true);
    setTimeout(() => {
      setIsAdPlaying(false);
      const today = new Date().toLocaleDateString();
      setProfile(prev => {
        const updated = {
          ...prev,
          gold: prev.gold + 50,
          adCredits: prev.adCredits - 1,
          lastAdDate: today
        };
        updateGlobalProfile(level, xp, updated.gold, updated.statPoints, updated.adCredits, updated.lastAdDate);
        return updated;
      });
      triggerConfetti();
      notify("ボーナス獲得！ 50G 手に入れました！");
    }, 3000);
  };

  const formatTime = (s) => `${Math.floor(s / 60)}:${(s % 60).toString().padStart(2, '0')}`;
  const currentTheme = themes[profile.theme] || themes.indigo;

  const daysInMonth = (date) => new Date(date.getFullYear(), date.getMonth() + 1, 0).getDate();
  const firstDayOfMonth = (date) => new Date(date.getFullYear(), date.getMonth(), 1).getDay();
  const formatMonth = (date) => `${date.getFullYear()}年 ${date.getMonth() + 1}月`;

  return (
    <div className={`min-h-screen ${currentTheme.bg} transition-colors duration-500 pb-24 font-sans relative`}>
      {showConfetti && <Confetti />}

      {/* Ad Overlay */}
      {isAdPlaying && (
        <div className="fixed inset-0 z-[1000] bg-black flex flex-col items-center justify-center text-white">
           <div className="w-64 h-64 bg-slate-900 rounded-3xl flex items-center justify-center animate-pulse mb-8 border-2 border-indigo-500/50">
              <Tv size={80} className="text-indigo-400" />
           </div>
           <h2 className="text-2xl font-black mb-2">動画広告を再生中...</h2>
           <p className="text-slate-400 font-bold">終了まであと少しお待ちください</p>
           <div className="mt-8 w-48 h-1 bg-slate-800 rounded-full overflow-hidden">
              <div className="h-full bg-indigo-500 animate-[loading-bar_3s_linear_forwards]" />
           </div>
           <style>{`
             @keyframes loading-bar {
               0% { width: 0%; }
               100% { width: 100%; }
             }
           `}</style>
        </div>
      )}

      {/* Focus Mode Overlay */}
      {isFocusMode && (
        <div className="fixed inset-0 z-[500] bg-slate-950 flex flex-col items-center justify-center text-white animate-in fade-in duration-700">
           <button onClick={() => setIsFocusMode(false)} className="absolute top-10 right-10 p-4 bg-white/10 rounded-full hover:bg-white/20 transition-all"><Shrink size={32}/></button>
           <div className={`text-xl font-black mb-4 tracking-[0.5em] uppercase ${timerMode === 'work' ? 'text-rose-500' : 'text-emerald-500'}`}>{timerMode === 'work' ? '集中時間' : '休憩中'}</div>
           <div className="text-[12rem] font-black tabular-nums leading-none mb-12">{formatTime(timeLeft)}</div>
           <div className="flex gap-6">
              <button onClick={() => setIsActive(!isActive)} className="px-12 py-6 bg-white text-slate-900 rounded-full font-black text-2xl hover:scale-110 transition-transform">{isActive ? <Pause size={40}/> : <Play size={40}/>}</button>
           </div>
        </div>
      )}

      {/* Notifications */}
      {notification && (
        <div className="fixed top-8 left-1/2 -translate-x-1/2 z-[200] bg-slate-900 text-white px-6 py-3 rounded-2xl shadow-2xl animate-bounce flex items-center gap-3">
          <Sparkles className="text-yellow-400 w-5 h-5" /> {notification}
        </div>
      )}

      {/* Profile Modal (Public View) */}
      {selectedUser && (
        <div className="fixed inset-0 z-[300] bg-black/60 backdrop-blur-sm flex items-center justify-center p-4" onClick={() => setSelectedUser(null)}>
          <div className="bg-white w-full max-w-md rounded-[40px] overflow-hidden shadow-2xl" onClick={e => e.stopPropagation()}>
            <div className={`p-8 ${themes[selectedUser.theme]?.primary || 'bg-indigo-600'} text-white relative`}>
               <button onClick={() => setSelectedUser(null)} className="absolute top-6 right-6 p-2 bg-black/20 rounded-full"><X /></button>
               <div className="flex items-center gap-6">
                 <div className="w-20 h-20 bg-white/20 rounded-3xl flex items-center justify-center text-white text-4xl">{avatarIcons[selectedUser.avatar] || <User />}</div>
                 <div>
                    <h3 className="text-2xl font-black">{selectedUser.name}</h3>
                    <p className="text-sm font-bold opacity-70">Lv.{selectedUser.level} {selectedUser.title}</p>
                 </div>
               </div>
            </div>
            <div className="p-8 space-y-6">
               <div className="bg-slate-50 p-4 rounded-2xl border border-slate-100">
                  <div className="text-[10px] font-black uppercase tracking-widest text-slate-400 mb-2">自己紹介</div>
                  <p className="text-sm text-slate-600 font-bold">{selectedUser.bio || "冒険者はまだ何も語っていない..."}</p>
               </div>
               <div className="grid grid-cols-2 gap-4">
                  {Object.entries(selectedUser.stats || {}).map(([k, v]) => (
                    <div key={k} className="bg-slate-50 p-3 rounded-2xl flex justify-between items-center text-xs">
                       <span className="font-black uppercase opacity-40">{k}</span>
                       <span className="font-black text-slate-700">{v}</span>
                    </div>
                  ))}
               </div>
            </div>
          </div>
        </div>
      )}

      <div className="max-w-5xl mx-auto p-4 md:p-8">
        {/* APP LOGO & TITLE SECTION */}
        <div className="flex items-center justify-center py-8 mb-4">
          <div className="flex items-center gap-3 bg-white/40 backdrop-blur-md px-8 py-4 rounded-[40px] border border-white/50 shadow-sm">
            <div className="p-3 bg-gradient-to-br from-indigo-600 to-violet-700 rounded-2xl text-white shadow-lg shadow-indigo-100">
               <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round">
                 <path d="M14.5 17.5L3 6V3h3l11.5 11.5" />
                 <path d="M13 19l6 2 3-10-10-3-2 6" />
                 <path d="M18 7a2 2 0 1 1-4 0 2 2 0 0 1 4 0Z" />
                 <path d="m7 12 5 5-1.5 1.5L5.5 13.5z" />
               </svg>
            </div>
            <div className="text-left">
              <h1 className="text-3xl font-[1000] tracking-tighter italic text-slate-900 leading-none">Task Manager <span className="text-indigo-600">RPG</span></h1>
              <p className="text-[10px] font-black uppercase tracking-[0.3em] text-slate-400 mt-1">Conquer your day, level up your life</p>
            </div>
          </div>
        </div>

        <header className="bg-white p-6 rounded-[32px] shadow-sm flex flex-wrap justify-between items-center mb-8 gap-4 border border-slate-100">
          <div className="flex items-center gap-4">
            <div className={`w-14 h-14 ${currentTheme.primary} rounded-2xl flex items-center justify-center text-white`}>{avatarIcons[profile.avatar]}</div>
            <div>
              <div className="flex items-center gap-2">
                <div className="font-black text-lg">{profile.name}</div>
                <span className="text-[10px] px-2 py-0.5 bg-indigo-50 text-indigo-500 rounded-full font-black">{profile.title}</span>
              </div>
              <div className="flex items-center gap-2">
                <span className="text-xs font-black text-indigo-500">Lv.{level}</span>
                <div className="w-24 h-1.5 bg-slate-100 rounded-full overflow-hidden">
                  <div className="h-full bg-indigo-500" style={{ width: `${(xp / (level * 200)) * 100}%` }} />
                </div>
              </div>
            </div>
          </div>
          <div className="flex items-center gap-3">
            <button 
                onClick={handleWatchAd}
                disabled={profile.adCredits <= 0}
                className={`flex items-center gap-2 px-4 py-2 rounded-2xl border transition-all ${profile.adCredits > 0 ? 'bg-indigo-50 border-indigo-100 text-indigo-600 hover:scale-105 active:scale-95' : 'bg-slate-50 border-slate-100 text-slate-300 cursor-not-allowed opacity-50'}`}
            >
              <Tv size={18} />
              <div className="text-left">
                  <div className="text-[10px] font-black leading-none">BONUS</div>
                  <div className="text-[8px] font-bold opacity-70">あと {profile.adCredits}回</div>
              </div>
            </button>

            <div className="flex items-center gap-2 bg-amber-50 px-4 py-2 rounded-2xl border border-amber-100">
              <Coins className="text-amber-500 w-5 h-5" />
              <span className="font-black text-amber-700">{profile.gold}G</span>
            </div>
            <nav className="flex bg-slate-100 p-1 rounded-2xl">
              {[
                { id: 'list', icon: <List /> },
                { id: 'calendar', icon: <CalendarIcon /> },
                { id: 'shop', icon: <ShoppingBag /> },
                { id: 'leaderboard', icon: <Globe /> },
                { id: 'profile', icon: <Settings /> }
              ].map(tab => (
                <button key={tab.id} onClick={() => setViewMode(tab.id)} className={`p-3 rounded-xl transition-all ${viewMode === tab.id ? 'bg-white shadow-sm text-indigo-600' : 'text-slate-400'}`}>{tab.icon}</button>
              ))}
            </nav>
          </div>
        </header>

        <div className="grid grid-cols-1 lg:grid-cols-12 gap-8">
          <aside className="lg:col-span-4 space-y-6">
             <div className="bg-white p-8 rounded-[40px] border border-slate-100 shadow-sm text-center relative group">
                <button onClick={() => setIsFocusMode(true)} className="absolute top-6 right-6 text-slate-300 hover:text-indigo-600 opacity-0 group-hover:opacity-100 transition-all"><Maximize2 size={20}/></button>
                <div className={`text-[10px] font-black uppercase tracking-[0.2em] mb-2 ${timerMode === 'work' ? 'text-rose-500' : 'text-emerald-500'}`}>{timerMode === 'work' ? '集中セッション' : '小休憩'}</div>
                <div className="text-5xl font-black tabular-nums mb-6">{formatTime(timeLeft)}</div>
                <button onClick={() => setIsActive(!isActive)} className={`w-full py-4 rounded-2xl font-black transition-all ${isActive ? 'bg-slate-100 text-slate-500' : 'bg-indigo-600 text-white shadow-lg shadow-indigo-100 hover:scale-105'}`}>
                   {isActive ? '一時停止' : '集中を開始'}
                </button>
             </div>

             <div className="bg-white p-6 rounded-[32px] border border-slate-100 shadow-sm">
                <div className="flex items-center justify-between mb-4">
                  <div className="flex items-center gap-2">
                    <Timer size={16} className="text-rose-500" />
                    <h4 className="text-xs font-black uppercase tracking-widest text-slate-800">本日の特別任務</h4>
                  </div>
                </div>
                <div className="space-y-3">
                   {dailyMissions.map(m => (
                     <div key={m.id} className={`group relative flex items-center gap-3 p-3 rounded-2xl transition-all ${m.completed ? 'bg-emerald-50/50' : 'bg-slate-50'}`}>
                        {m.completed ? <CheckCircle2 size={14} className="text-emerald-500" /> : <Circle size={14} className="text-slate-300" />}
                        <div className="flex-1 min-w-0">
                           <div className={`text-[11px] font-bold truncate ${m.completed ? 'text-slate-400 line-through italic' : 'text-slate-700'}`}>{m.text}</div>
                           {!m.completed && (
                             <div className="flex justify-between items-center mt-1">
                                <div className="text-[8px] font-black text-rose-400">+{m.xp}XP / +{m.gold}G</div>
                                {m.id === 'daily_tasks' && (
                                  <div className="text-[8px] font-black text-slate-400 bg-white px-1.5 py-0.5 rounded-full border border-slate-100">
                                    {m.current} / {m.target}
                                  </div>
                                )}
                             </div>
                           )}
                        </div>
                     </div>
                   ))}
                </div>
             </div>
             
             <div className="bg-white p-6 rounded-[32px] border border-slate-100 shadow-sm">
                <div className="flex items-center gap-2 mb-4">
                  <Backpack size={16} className="text-amber-500" />
                  <h4 className="text-xs font-black uppercase tracking-widest text-slate-800">現在の装備</h4>
                </div>
                <div className="grid grid-cols-1 gap-2">
                  <div className="flex items-center gap-3 p-2 bg-slate-50 rounded-xl">
                    <Sword size={12} className="text-slate-400" />
                    <span className="text-[10px] font-black text-slate-600">{profile.equipment.weapon}</span>
                  </div>
                  <div className="flex items-center gap-3 p-2 bg-slate-50 rounded-xl">
                    <Shield size={12} className="text-slate-400" />
                    <span className="text-[10px] font-black text-slate-600">{profile.equipment.armor}</span>
                  </div>
                  <div className="flex items-center gap-3 p-2 bg-slate-50 rounded-xl">
                    <Crown size={12} className="text-slate-400" />
                    <span className="text-[10px] font-black text-slate-600">{profile.equipment.accessory}</span>
                  </div>
                </div>
             </div>
          </aside>

          <main className="lg:col-span-8">
             {viewMode === 'list' && (
               <div className="space-y-4 animate-in fade-in duration-500">
                  <form onSubmit={addTask} className="bg-white p-3 rounded-[32px] shadow-sm space-y-3 border border-slate-100">
                    <div className="flex gap-2">
                      <input 
                        type="text" 
                        value={inputValue} 
                        onChange={(e) => setInputValue(e.target.value)} 
                        placeholder="新しいクエストを入力..." 
                        className="flex-1 px-6 py-3 bg-slate-50 rounded-2xl outline-none font-bold focus:bg-white transition-colors border border-transparent focus:border-indigo-100" 
                      />
                    </div>
                    <div className="flex items-center gap-2">
                      <div className="flex items-center gap-2 bg-slate-50 px-4 py-2 rounded-2xl flex-1 border border-slate-100">
                        <CalendarIcon size={16} className="text-slate-400" />
                        <span className="text-xs font-bold text-slate-400 mr-2">期限:</span>
                        <input 
                          type="date" 
                          value={inputDate} 
                          onChange={(e) => setInputDate(e.target.value)} 
                          className="bg-transparent text-xs font-bold outline-none text-slate-600 flex-1"
                        />
                      </div>
                      <button className="bg-indigo-600 text-white px-8 py-3 rounded-2xl font-black flex items-center gap-2 hover:bg-indigo-700 transition-colors shadow-lg shadow-indigo-50">
                        <Plus size={20} /> 受注
                      </button>
                    </div>
                  </form>

                  {tasks.length === 0 ? (
                    <div className="text-center py-20 opacity-30 flex flex-col items-center">
                      <Backpack size={64} className="mb-4" />
                      <p className="font-black">現在進行中のクエストはありません</p>
                    </div>
                  ) : (
                    tasks.map(t => (
                      <div key={t.id} className={`bg-white p-5 rounded-[24px] flex items-center justify-between border border-slate-100 transition-all ${t.completed ? 'opacity-40 scale-95 border-emerald-100 bg-emerald-50/20' : 'hover:translate-x-1 shadow-sm'}`}>
                         <div className="flex items-center gap-4">
                            <button className="transition-transform active:scale-90 relative" onClick={() => completeTask(t.id)}>
                              {t.completed ? (
                                <CheckCircle2 className="text-emerald-500" />
                              ) : (
                                <Circle className="text-slate-200 hover:text-indigo-400" />
                              )}
                            </button>
                            <div>
                               <div className={`font-black ${t.completed ? 'line-through text-slate-400 italic' : 'text-slate-800'}`}>{t.text}</div>
                               {t.deadline && !t.completed && (
                                 <div className="flex items-center gap-1 mt-1 text-[10px] font-black text-rose-400">
                                    <Clock size={10} /> {t.deadline} まで
                                 </div>
                               )}
                            </div>
                         </div>
                         {!t.completed && (
                           <button onClick={() => setTasks(tasks.filter(tk => tk.id !== t.id))} className="text-slate-200 hover:text-rose-500 transition-colors">
                             <Trash2 size={18} />
                           </button>
                         )}
                      </div>
                    ))
                  )}
               </div>
             )}

             {viewMode === 'calendar' && (
               <div className="bg-white p-8 rounded-[40px] border border-slate-100 shadow-sm animate-in zoom-in-95 duration-500">
                  <div className="flex justify-between items-center mb-8">
                    <h3 className="text-2xl font-black italic uppercase tracking-tighter text-indigo-600">{formatMonth(currentDate)}</h3>
                    <div className="flex gap-3">
                       <button onClick={() => setCurrentDate(new Date(currentDate.setMonth(currentDate.getMonth()-1)))} className="p-3 bg-slate-50 rounded-2xl hover:bg-slate-100"><ChevronLeft /></button>
                       <button onClick={() => setCurrentDate(new Date(currentDate.setMonth(currentDate.getMonth()+1)))} className="p-3 bg-slate-50 rounded-2xl hover:bg-slate-100"><ChevronRight /></button>
                    </div>
                  </div>
                  <div className="grid grid-cols-7 gap-4">
                    {Array.from({ length: firstDayOfMonth(currentDate) }).map((_, i) => <div key={i} className="h-20 bg-slate-50/50 rounded-2xl" />)}
                    {Array.from({ length: daysInMonth(currentDate) }).map((_, i) => {
                      const day = i + 1;
                      const isToday = day === new Date().getDate() && currentDate.getMonth() === new Date().getMonth();
                      return (
                        <div key={i} className={`h-20 p-2 rounded-2xl border text-xs font-black ${isToday ? 'bg-indigo-50 border-indigo-200 text-indigo-600' : 'bg-white border-slate-50 text-slate-400'}`}>
                          {day}
                        </div>
                      );
                    })}
                  </div>
               </div>
             )}

             {viewMode === 'shop' && (
               <div className="grid grid-cols-1 md:grid-cols-2 gap-4 animate-in zoom-in-95 duration-500">
                  {shopItems.map(item => (
                    <div key={item.id} className="bg-white p-6 rounded-[32px] border border-slate-100 flex flex-col justify-between group">
                       <div className="flex items-start justify-between mb-4">
                          <div className="w-12 h-12 bg-indigo-50 rounded-2xl flex items-center justify-center text-indigo-600 group-hover:scale-110 transition-transform">{item.icon}</div>
                          <div className="text-right">
                             <div className="text-sm font-black text-amber-600">{item.price}G</div>
                             <div className="text-[10px] font-black text-emerald-500">{item.effect}</div>
                          </div>
                       </div>
                       <h4 className="font-black text-lg mb-4">{item.name}</h4>
                       <button onClick={() => buyItem(item)} className="w-full py-3 bg-slate-900 text-white rounded-2xl font-black text-xs hover:bg-indigo-600 transition-colors">購入する</button>
                    </div>
                  ))}
               </div>
             )}

             {viewMode === 'leaderboard' && (
               <div className="bg-white rounded-[40px] border border-slate-100 overflow-hidden shadow-sm animate-in slide-in-from-right-8 duration-500">
                  <div className="p-8 border-b border-slate-50 flex justify-between items-center">
                    <h3 className="text-xl font-black italic uppercase">Adventurers Ranking</h3>
                    <Globe className="text-slate-200" />
                  </div>
                  <div className="divide-y divide-slate-50">
                    {leaderboard.map((entry, idx) => (
                      <div key={entry.id} onClick={() => setSelectedUser(entry)} className="p-6 flex items-center justify-between cursor-pointer hover:bg-slate-50 transition-all">
                         <div className="flex items-center gap-5">
                            <span className="w-6 font-black italic opacity-20">#{idx+1}</span>
                            <div className="w-10 h-10 bg-slate-100 rounded-xl flex items-center justify-center text-slate-400">{avatarIcons[entry.avatar] || <User />}</div>
                            <div className="font-black">{entry.name}</div>
                         </div>
                         <div className="flex items-center gap-4">
                            <div className="font-black text-indigo-600">Lv.{entry.level}</div>
                            <ChevronRight className="text-slate-200" />
                         </div>
                      </div>
                    ))}
                  </div>
               </div>
             )}

             {viewMode === 'profile' && (
                <div className="space-y-6 animate-in fade-in duration-500">
                   <div className="bg-white p-8 rounded-[40px] border border-slate-100 shadow-sm space-y-6">
                      <div className="flex items-center gap-2 mb-2">
                         <PenTool size={16} className="text-indigo-600" />
                         <h4 className="text-xs font-black uppercase tracking-widest text-slate-800">基本プロフィール</h4>
                      </div>
                      <div className="flex flex-wrap items-center gap-6">
                         <div className="w-24 h-24 bg-indigo-600 rounded-[32px] flex items-center justify-center text-white text-4xl shadow-xl shadow-indigo-100 relative">
                            {avatarIcons[profile.avatar]}
                            <div className="absolute -bottom-2 -right-2 bg-white p-1.5 rounded-full shadow-md text-indigo-600">
                               <Palette size={14} />
                            </div>
                         </div>
                         <div className="flex-1 space-y-4">
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                               <div>
                                  <label className="text-[10px] font-black uppercase text-slate-400 ml-2">名前</label>
                                  <input type="text" value={profile.name} onChange={(e) => setProfile({...profile, name: e.target.value})} className="w-full px-4 py-2 bg-slate-50 rounded-xl font-black focus:bg-white border border-transparent focus:border-indigo-100 outline-none transition-all" />
                               </div>
                               <div>
                                  <label className="text-[10px] font-black uppercase text-slate-400 ml-2">称号</label>
                                  <input type="text" value={profile.title} onChange={(e) => setProfile({...profile, title: e.target.value})} className="w-full px-4 py-2 bg-slate-50 rounded-xl font-black focus:bg-white border border-transparent focus:border-indigo-100 outline-none transition-all" />
                               </div>
                            </div>
                            <div>
                               <label className="text-[10px] font-black uppercase text-slate-400 ml-2">自己紹介</label>
                               <textarea value={profile.bio} onChange={(e) => setProfile({...profile, bio: e.target.value})} className="w-full px-4 py-2 bg-slate-50 rounded-xl font-bold focus:bg-white border border-transparent focus:border-indigo-100 outline-none transition-all h-20 resize-none" placeholder="冒険への意気込みを語ろう..."/>
                            </div>
                         </div>
                      </div>

                      <div className="flex gap-3 overflow-x-auto pb-2 scrollbar-hide">
                         {profile.unlockedAvatars.map(av => (
                           <button key={av} onClick={() => setProfile({...profile, avatar: av})} className={`min-w-[48px] h-[48px] rounded-xl flex items-center justify-center transition-all ${profile.avatar === av ? 'bg-indigo-600 text-white shadow-lg shadow-indigo-100 scale-110' : 'bg-slate-50 text-slate-300 hover:bg-slate-100'}`}>{avatarIcons[av]}</button>
                         ))}
                      </div>
                   </div>

                   <div className="bg-white p-8 rounded-[40px] border border-slate-100 shadow-sm">
                      <div className="flex justify-between items-center mb-6">
                         <div className="flex items-center gap-2">
                            <Activity size={16} className="text-rose-500" />
                            <h4 className="text-xs font-black uppercase tracking-widest text-slate-800">ステータス強化</h4>
                         </div>
                         {profile.statPoints > 0 && (
                            <div className="bg-rose-100 text-rose-600 text-[10px] font-black px-3 py-1 rounded-full animate-pulse">
                               残りポイント: {profile.statPoints}
                            </div>
                         )}
                      </div>
                      <div className="grid grid-cols-2 md:grid-cols-3 gap-4">
                         {Object.entries(profile.stats).map(([stat, value]) => (
                           <div key={stat} className="bg-slate-50 p-4 rounded-3xl group transition-all hover:bg-white hover:shadow-md border border-transparent hover:border-slate-100">
                              <div className="flex justify-between items-center mb-2">
                                 <span className="text-[10px] font-black uppercase text-slate-400">{stat}</span>
                                 <span className="text-lg font-black text-slate-800">{value}</span>
                              </div>
                              <button 
                                onClick={() => allocatePoint(stat)}
                                disabled={profile.statPoints <= 0}
                                className={`w-full py-2 rounded-xl flex items-center justify-center transition-all ${profile.statPoints > 0 ? 'bg-indigo-600 text-white hover:scale-105 active:scale-95' : 'bg-slate-100 text-slate-300 cursor-not-allowed'}`}
                              >
                                 <Plus size={16} />
                              </button>
                           </div>
                         ))}
                      </div>
                   </div>

                   <div className="bg-white p-8 rounded-[40px] border border-slate-100 shadow-sm">
                      <div className="flex items-center gap-2 mb-6">
                         <UserPlus size={16} className="text-indigo-600" />
                         <h4 className="text-xs font-black uppercase tracking-widest text-slate-800">ジョブ・クラス</h4>
                      </div>
                      <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                         {jobClasses.map(job => (
                           <button 
                             key={job.id} 
                             onClick={() => setProfile({...profile, job: job.id})}
                             className={`p-5 rounded-[32px] text-left transition-all border-2 ${profile.job === job.id ? 'bg-indigo-50 border-indigo-500 shadow-lg' : 'bg-white border-slate-50 hover:border-indigo-100'}`}
                           >
                              <div className="flex items-center gap-4 mb-2">
                                 <div className={`p-3 rounded-2xl ${profile.job === job.id ? 'bg-indigo-600 text-white' : 'bg-slate-100 text-slate-400'}`}>{job.icon}</div>
                                 <div>
                                    <div className="font-black text-slate-800">{job.name}</div>
                                    <div className="text-[10px] font-bold text-slate-400">{job.description}</div>
                                 </div>
                              </div>
                              <div className="flex gap-2 mt-4 overflow-x-auto">
                                 {Object.entries(job.stats).map(([s, v]) => (
                                   <div key={s} className="bg-white/50 px-2 py-1 rounded-lg text-[8px] font-black text-slate-500 border border-slate-100 whitespace-nowrap">
                                      {s.toUpperCase()} +{v}
                                   </div>
                                 ))}
                              </div>
                           </button>
                         ))}
                      </div>
                   </div>

                   <div className="bg-white p-8 rounded-[40px] border border-slate-100 shadow-sm space-y-6">
                      <div className="flex items-center gap-2 mb-2">
                         <Palette size={16} className="text-indigo-600" />
                         <h4 className="text-xs font-black uppercase tracking-widest text-slate-800">外観設定</h4>
                      </div>
                      <div className="flex gap-4">
                         {Object.entries(themes).map(([key, t]) => (
                           <button 
                             key={key} 
                             onClick={() => setProfile({...profile, theme: key})}
                             className={`flex-1 p-4 rounded-3xl border-2 transition-all ${profile.theme === key ? 'border-indigo-500 bg-indigo-50' : 'border-slate-50 bg-white hover:border-indigo-100'}`}
                           >
                              <div className={`w-8 h-8 ${t.primary} rounded-full mx-auto mb-2 shadow-sm`} />
                              <div className="text-[10px] font-black text-center text-slate-600">{t.name}</div>
                           </button>
                         ))}
                      </div>
                      <button onClick={() => updateGlobalProfile()} className="w-full py-4 bg-slate-900 text-white rounded-[24px] font-black shadow-xl shadow-slate-100 hover:bg-indigo-600 hover:scale-[1.02] transition-all flex items-center justify-center gap-3">
                         <Save size={20} /> 冒険の記録を同期する
                      </button>
                   </div>
                </div>
             )}
          </main>
        </div>
      </div>
    </div>
  );
}